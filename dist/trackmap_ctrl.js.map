{"version":3,"sources":["../src/trackmap_ctrl.js"],"names":["L","moment","appEvents","MetricsPanelCtrl","panelDefaults","maxDataPoints","autoZoom","lineColor","pointColor","TrackMapCtrl","$scope","$injector","_","defaults","panel","timeSrv","get","coords","leafMap","locationLayer","polyline","hoverMarker","hoverTarget","events","on","onInitEditMode","bind","onPanelTeardown","onPanelSizeChanged","onDataReceived","onPanelHover","onPanelClear","addEditorTab","$timeout","cancel","nextTickPromise","evt","length","target","Math","floor","pos","x","bringToFront","setStyle","fillColor","color","min","max","idx","exact","timestamp","setLatLng","position","invalidateSize","map","id","scrollWheelZoom","zoomSnap","zoomDelta","featureGroup","addTo","control","layers","tileLayer","attribution","maxZoom","forcedOverlay","subdomains","circleMarker","latLng","fillOpacity","weight","radius","mapBaseLayerChange","mapZoomToBox","e","removeFrom","overlay","layer","options","setZIndex","zIndex","bounds","reduce","t","c","boxZoomBounds","contains","from","to","Infinity","isFinite","setTime","utc","clearLayers","i","pollution","svg_cloud","meIcon","divIcon","className","html","replace","iconAnchor","iconSize","popupAnchor","console","log","meMarker","marker","icon","title","location","addLayer","zoomToFit","latLongObj","maxMin","latLong","markersObj","maxLat","getMinOrMax","minLat","maxLng","minLng","southWest","LatLng","northEast","LatLngBounds","fitBounds","getBounds","pad","data","setupMap","setView","datapoints","aqi","lat","lon","city","push","addDataToMap","templateUrl"],"mappings":"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","sourcesContent":["import L from './leaflet/leaflet.js';\r\nimport moment from 'moment';\r\n\r\nimport appEvents from 'app/core/app_events';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\n\r\nimport './leaflet/leaflet.css!';\r\nimport './partials/module.css!';\r\n\r\nconst panelDefaults = {\r\n  maxDataPoints: 500,\r\n  autoZoom: true,\r\n  lineColor: 'red',\r\n  pointColor: 'royalblue',\r\n}\r\n\r\nexport class TrackMapCtrl extends MetricsPanelCtrl {\r\n  constructor($scope, $injector) {\r\n    super($scope, $injector);\r\n    _.defaults(this.panel, panelDefaults);\r\n\r\n    this.timeSrv = $injector.get('timeSrv');\r\n    this.coords = [];\r\n    this.leafMap = null;\r\n    this.locationLayer = null;\r\n    this.polyline = null;\r\n    this.hoverMarker = null;\r\n    this.hoverTarget = null;\r\n\r\n    // Panel events\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\r\n    this.events.on('panel-size-changed', this.onPanelSizeChanged.bind(this));\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n\r\n    // Global events\r\n    appEvents.on('graph-hover', this.onPanelHover.bind(this));\r\n    appEvents.on('graph-hover-clear', this.onPanelClear.bind(this));\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.addEditorTab('Options', 'public/plugins/pr0ps-trackmap-panel/partials/options.html', 2);\r\n  }\r\n\r\n  onPanelTeardown() {\r\n    this.$timeout.cancel(this.nextTickPromise);\r\n  }\r\n\r\n  onPanelHover(evt) {\r\n    if (this.coords.length === 0) {\r\n      return;\r\n    }\r\n\r\n    // check if we are already showing the correct hoverMarker\r\n    let target = Math.floor(evt.pos.x);\r\n    if (this.hoverTarget && this.hoverTarget === target) {\r\n      return;\r\n    }\r\n\r\n    // check for initial show of the marker\r\n    if (this.hoverTarget == null){\r\n      this.hoverMarker.bringToFront()\r\n                      .setStyle({\r\n                        fillColor: this.panel.pointColor,\r\n                        color: 'white'\r\n                      });\r\n    }\r\n\r\n    this.hoverTarget = target;\r\n\r\n    // Find the currently selected time and move the hoverMarker to it\r\n    // Note that an exact match isn't always going to work due to rounding so\r\n    // we clean that up later (still more efficient)\r\n    let min = 0;\r\n    let max = this.coords.length - 1;\r\n    let idx = null;\r\n    let exact = false;\r\n    while (min <= max) {\r\n      idx = Math.floor((max + min) / 2);\r\n      if (this.coords[idx].timestamp === this.hoverTarget) {\r\n        exact = true;\r\n        break;\r\n      }\r\n      else if (this.coords[idx].timestamp < this.hoverTarget) {\r\n        min = idx + 1;\r\n      }\r\n      else {\r\n        max = idx - 1;\r\n      }\r\n    }\r\n\r\n    // Correct the case where we are +1 index off\r\n    if (!exact && idx > 0 && this.coords[idx].timestamp > this.hoverTarget) {\r\n      idx--;\r\n    }\r\n    this.hoverMarker.setLatLng(this.coords[idx].position);\r\n  }\r\n\r\n  onPanelClear(evt) {\r\n    // clear the highlighted circle\r\n    this.hoverTarget = null;\r\n    if (this.hoverMarker) {\r\n      this.hoverMarker.setStyle({\r\n        fillColor: 'none',\r\n        color: 'none'\r\n      });\r\n    }\r\n  }\r\n\r\n  onPanelSizeChanged() {\r\n    if (this.leafMap) {\r\n      this.leafMap.invalidateSize();\r\n    }\r\n  }\r\n\r\n  setupMap() {\r\n    // Create the map or get it back in a clean state if it already exists\r\n    if (this.leafMap) {\r\n      this.onPanelClear();\r\n      return;\r\n    }\r\n\r\n    // Create the map\r\n    this.leafMap = L.map('trackmap-' + this.panel.id, {\r\n      scrollWheelZoom: true,\r\n      zoomSnap: 0.5,\r\n      zoomDelta: 1\r\n    });\r\n    this.locationLayer = L.featureGroup().addTo(this.leafMap);\r\n\r\n\r\n\r\n\r\n\r\n\r\n    //check\r\n    \r\n\r\n\t\r\n\r\n\t//$('.mePin').addClass('bounce');\r\n\r\n    //check\r\n\r\n    // Define layers and add them to the control widget\r\n    L.control.layers({\r\n      'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n        attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>',\r\n        maxZoom: 19,\r\n        //noWrap: true\r\n      }).addTo(this.leafMap), // Add default layer to map\r\n      'OpenTopoMap': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {\r\n        attribution: 'Map data: &copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>, <a href=\"http://viewfinderpanoramas.org\">SRTM</a> | Map style: &copy; <a href=\"https://opentopomap.org\">OpenTopoMap</a> (<a href=\"https://creativecommons.org/licenses/by-sa/3.0/\">CC-BY-SA</a>)',\r\n        maxZoom: 17,\r\n        //noWrap: true\r\n      }),\r\n      'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {\r\n        attribution: 'Imagery &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',\r\n        // This map doesn't have labels so we force a label-only layer on top of it\r\n        forcedOverlay: L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png', {\r\n          attribution: 'Labels by <a href=\"http://stamen.com\">Stamen Design</a>, <a href=\"http://creativecommons.org/licenses/by/3.0\">CC BY 3.0</a> &mdash; Map data &copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>',\r\n          subdomains: 'abcd',\r\n          maxZoom: 20,\r\n          //noWrap: true\r\n        })\r\n      })\r\n    }).addTo(this.leafMap);\r\n\r\n    this.hoverMarker = L.circleMarker(L.latLng(0, 0), {\r\n      color: 'none',\r\n      fillColor: 'none',\r\n      fillOpacity: 1,\r\n      weight: 2,\r\n      radius: 7\r\n    }).addTo(this.leafMap);\r\n\r\n    // Events\r\n    this.leafMap.on('baselayerchange', this.mapBaseLayerChange.bind(this));\r\n    this.leafMap.on('boxzoomend', this.mapZoomToBox.bind(this));\r\n  }\r\n\r\n  mapBaseLayerChange(e) {\r\n    // If a tileLayer has a 'forcedOverlay' attribute, always enable/disable it\r\n    // along with the layer\r\n    if (this.leafMap.forcedOverlay) {\r\n      this.leafMap.forcedOverlay.removeFrom(this.leafMap);\r\n      this.leafMap.forcedOverlay = null;\r\n    }\r\n    let overlay = e.layer.options.forcedOverlay;\r\n    if (overlay) {\r\n      overlay.addTo(this.leafMap);\r\n      overlay.setZIndex(e.layer.options.zIndex + 1);\r\n      this.leafMap.forcedOverlay = overlay;\r\n    }\r\n  }\r\n\r\n  mapZoomToBox(e) {\r\n    // Find time bounds of selected coordinates\r\n    const bounds = this.coords.reduce(\r\n      function(t, c) {\r\n        if (e.boxZoomBounds.contains(c.position)) {\r\n          t.from = Math.min(t.from, c.timestamp);\r\n          t.to = Math.max(t.to, c.timestamp);\r\n        }\r\n        return t;\r\n      },\r\n      {from: Infinity, to: -Infinity}\r\n    );\r\n\r\n    // Set the global time range\r\n    if (isFinite(bounds.from) && isFinite(bounds.to)) {\r\n      // KLUDGE: Create moment objects here to avoid a TypeError that\r\n      // occurs when Grafana processes normal numbers\r\n      this.timeSrv.setTime({\r\n        from: moment.utc(bounds.from),\r\n        to: moment.utc(bounds.to)\r\n      });\r\n    }\r\n  }\r\n\r\n  // Add the circles and polyline to the map\r\n  addDataToMap() {\r\n    //console.log(this.coords);\r\n    this.locationLayer.clearLayers();\r\n    \r\n    for(var i=0;i<this.coords.length;i++) {\r\n      if(this.coords[i].pollution <= 50)\r\n          var svg_cloud = '<svg class=\"clouds cloud-green\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0\" y=\"0\" width=\"512\" height=\"512\" viewBox=\"0 0 512 512\" enable-background=\"new 0 0 512 512\" xml:space=\"preserve\"><path id=\"cloud-icon\" d=\"M406.1 227.63c-8.23-103.65-144.71-137.8-200.49-49.05 -36.18-20.46-82.33 3.61-85.22 45.9C80.73 229.34 50 263.12 50 304.1c0 44.32 35.93 80.25 80.25 80.25h251.51c44.32 0 80.25-35.93 80.25-80.25C462 268.28 438.52 237.94 406.1 227.63z\"/></svg>'\r\n      else if(this.coords[i].pollution <= 100)\r\n        var svg_cloud = '<svg class=\"clouds cloud-yellow\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0\" y=\"0\" width=\"512\" height=\"512\" viewBox=\"0 0 512 512\" enable-background=\"new 0 0 512 512\" xml:space=\"preserve\"><path id=\"cloud-icon\" d=\"M406.1 227.63c-8.23-103.65-144.71-137.8-200.49-49.05 -36.18-20.46-82.33 3.61-85.22 45.9C80.73 229.34 50 263.12 50 304.1c0 44.32 35.93 80.25 80.25 80.25h251.51c44.32 0 80.25-35.93 80.25-80.25C462 268.28 438.52 237.94 406.1 227.63z\"/></svg>'\r\n      else if(this.coords[i].pollution <= 150)\r\n        var svg_cloud = '<svg class=\"clouds cloud-orange\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0\" y=\"0\" width=\"512\" height=\"512\" viewBox=\"0 0 512 512\" enable-background=\"new 0 0 512 512\" xml:space=\"preserve\"><path id=\"cloud-icon\" d=\"M406.1 227.63c-8.23-103.65-144.71-137.8-200.49-49.05 -36.18-20.46-82.33 3.61-85.22 45.9C80.73 229.34 50 263.12 50 304.1c0 44.32 35.93 80.25 80.25 80.25h251.51c44.32 0 80.25-35.93 80.25-80.25C462 268.28 438.52 237.94 406.1 227.63z\"/></svg>'\r\n      else if(this.coords[i].pollution <= 200)\r\n        var svg_cloud = '<svg class=\"clouds cloud-red\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0\" y=\"0\" width=\"512\" height=\"512\" viewBox=\"0 0 512 512\" enable-background=\"new 0 0 512 512\" xml:space=\"preserve\"><path id=\"cloud-icon\" d=\"M406.1 227.63c-8.23-103.65-144.71-137.8-200.49-49.05 -36.18-20.46-82.33 3.61-85.22 45.9C80.73 229.34 50 263.12 50 304.1c0 44.32 35.93 80.25 80.25 80.25h251.51c44.32 0 80.25-35.93 80.25-80.25C462 268.28 438.52 237.94 406.1 227.63z\"/></svg>'\r\n      else if(this.coords[i].pollution <= 250)\r\n        var svg_cloud = '<svg class=\"clouds cloud-purple\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" x=\"0\" y=\"0\" width=\"512\" height=\"512\" viewBox=\"0 0 512 512\" enable-background=\"new 0 0 512 512\" xml:space=\"preserve\"><path id=\"cloud-icon\" d=\"M406.1 227.63c-8.23-103.65-144.71-137.8-200.49-49.05 -36.18-20.46-82.33 3.61-85.22 45.9C80.73 229.34 50 263.12 50 304.1c0 44.32 35.93 80.25 80.25 80.25h251.51c44.32 0 80.25-35.93 80.25-80.25C462 268.28 438.52 237.94 406.1 227.63z\"/></svg>'\r\n    \r\n    var meIcon = L.divIcon({\r\n\t\tclassName: \"leaflet-data-marker\",\r\n\t\t\thtml: svg_cloud.replace('#','%23'),\r\n\r\n\t\t\ticonAnchor  : [22, 28],\r\n\t\t\ticonSize    : [36, 42],\r\n\t\t\tpopupAnchor : [0, -30],\r\n\t\t});\r\n      console.log(this.coords[i] + \"llll\");\r\n    var meMarker = L.marker(this.coords[i].position, {\r\n      icon: meIcon,\r\n      title: \"AQI is \"+ this.coords[i].pollution +\" in \" + this.coords[i].location\r\n    })\r\n\r\n    this.locationLayer.addLayer(meMarker);\r\n  }\r\n    this.zoomToFit();\r\n\r\n  }\r\n  getMinOrMax(latLongObj,maxMin,latLong) {\r\n\r\n  }\r\n  getBounds (markersObj) {\r\n    var maxLat = getMinOrMax(markersObj, \"max\", \"lat\");\r\n    var minLat = getMinOrMax(markersObj, \"min\", \"lat\");\r\n    var maxLng = getMinOrMax(markersObj, \"max\", \"lng\");\r\n    var minLng = getMinOrMax(markersObj, \"min\", \"lng\");\r\n    var southWest = new L.LatLng(minLat, minLng);\r\n    var northEast = new L.LatLng(maxLat, maxLng);\r\n    return new L.LatLngBounds(southWest, northEast);\r\n  }\r\n\r\n  zoomToFit(){\r\n    if (this.panel.autoZoom){\r\n      // this.leafMap.fitWorld();\r\n//       var corner1 = L.latLng(40.712, -74.227),\r\n// corner2 = L.latLng(40.774, -74.125),\r\n// bounds = L.latLngBounds(corner1, corner2);\r\nthis.leafMap.fitBounds(this.locationLayer.getBounds().pad(0.5));\r\n    }\r\n  }\r\n\r\n  refreshColors() {\r\n    if (this.polyline) {\r\n      this.polyline.setStyle({\r\n        color: this.panel.lineColor\r\n      });\r\n    }\r\n  }\r\n\r\n  onDataReceived(data) {\r\n    this.setupMap();\r\n    console.log(data.length);\r\n    if (data.length === 0 ) {\r\n      // No data or incorrect data, show a world map and abort\r\n      this.leafMap.setView([0, 0], 1);\r\n      return;\r\n    }\r\n    console.log(data);\r\n    // Asumption is that there are an equal number of properly matched timestamps\r\n    // TODO: proper joining by timestamp?\r\n    this.coords.length = 0;\r\n    for(var i=0;i<data[0].datapoints.length;i++) {\r\n      let aqi = data[0].datapoints[i][0];\r\n      let lat = data[1].datapoints[i];\r\n      let lon = data[2].datapoints[i];\r\n      const city = data[3].datapoints[i][0];\r\n      console.log(lat[0]);\r\n      this.coords.push({\r\n          position: L.latLng(lat[0], lon[0]),\r\n          location: city,\r\n          pollution: aqi,\r\n          timestamp: lat[1]\r\n        });\r\n    }\r\n    this.addDataToMap();\r\n  }\r\n}\r\n\r\nTrackMapCtrl.templateUrl = 'partials/module.html';"],"file":"trackmap_ctrl.js"}